---
title: "Simstudy-1-lag-variation"
author: "Kelsey"
date: "9/12/2021"
output: html_document
---

```{r}
require(knitr)
```
```{r}
#knitr::opts_knit$set(root.dir = "C:/Users/Kelsey/Documents/codingwork/simulation_study") #set the working directory
```
```{r}
#get the needed packages
if(!require("pacman")){
	install.packages("pacman")
	library(pacman)}
p_load("dplyr", "ggplot2", "viridis", "tidyr",  "fGarch", "sn", "purrr", "forcats", "stats", "changepoint", "changepoint.np")
```

```{r}
sim_spp <- read.csv(file = "sim_spp.csv",  header=T, sep=',', na.strings=c("","NA"), stringsAsFactors=F)
accumulated <- read.csv(file = "accumulated.csv",  header=T, sep=',', na.strings=c("","NA"), stringsAsFactors=F)

accumulated
```

### Changepoint Analysis

```{r}
a2 <- changepoint::cpt.meanvar(accumulated$Taxa_Naturalized, penalty = "MBIC", method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)
```


```{r}
changepoint::param.est(a2)
```
```{r}
sqrt(changepoint::param.est(a2)$variance)
```

```{r}
accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
```


# Scenario 1: Constant Lag Scenario
### Hypothetical Reality = Species are accumulating linearly
### Lags = Lags exist, as defined by the gamma distribution parameters
### Analyse Trends based on = A) Date of vouchered specimen, and B) Date the species is reported as new C) date of intoduction

## Simulate Hypothetical Lag Times

```{r}
sim_spp1 <- sim_spp
sim_spp1
```

##### 3.0
Simulate the lag between introduction and naturalization



```{r}
shape = 1.3
rate = 0.15
```

```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)
```

##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
#shape = 1.3
#rate = 0.15

set.seed(NULL)
Nat_Detect_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate))) *2

colnames(Nat_Detect_Lag) <- "Nat_Detect_Lag"
Nat_Detect_Lag <- subset(Nat_Detect_Lag, Nat_Detect_Lag >=0 & Nat_Detect_Lag <=500)
Nat_Detect_Lag <- as.data.frame(sample(Nat_Detect_Lag$Nat_Detect_Lag, 1000))
colnames(Nat_Detect_Lag) <- "Nat_Detect_Lag"
ave(Nat_Detect_Lag)
#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)

```


##### 3.3

third, simulate the lag between vouchering and identification

```{r}

#shape = 1.3
#rate = 0.15

set.seed(NULL)
Vouch_ID_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Vouch_ID_Lag) <- "Vouch_ID_Lag"
Vouch_ID_Lag <- subset(Vouch_ID_Lag, Vouch_ID_Lag >=0 & Vouch_ID_Lag <=500)
Vouch_ID_Lag <- as.data.frame(sample(Vouch_ID_Lag$Vouch_ID_Lag, 1000))
colnames(Vouch_ID_Lag) <- "Vouch_ID_Lag"
ave(Vouch_ID_Lag)
#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)
```

##### 3.4

Then, simulate the lag between IDing and reporting
```{r}
#shape = 1.3
#rate = 0.15

set.seed(NULL)
ID_Report_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(ID_Report_Lag) <- "ID_Report_Lag"
ID_Report_Lag <- subset(ID_Report_Lag, ID_Report_Lag >=0 & ID_Report_Lag <=500)
ID_Report_Lag <- as.data.frame(sample(ID_Report_Lag$ID_Report_Lag, 1000))
colnames(ID_Report_Lag) <- "ID_Report_Lag"
ave(ID_Report_Lag)
#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)
# summary(ID_Report_Lag)
```


##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years
```{r}
#shape = 1.3
#rate = 0.15

set.seed(NULL)
Report_Compile_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Report_Compile_Lag) <- "Report_Compile_Lag"
Report_Compile_Lag <- subset(Report_Compile_Lag, Report_Compile_Lag >=0 & Report_Compile_Lag <=500)
Report_Compile_Lag <- as.data.frame(sample(Report_Compile_Lag$Report_Compile_Lag, 1000))
colnames(Report_Compile_Lag) <- "Report_Compile_Lag"
ave(Report_Compile_Lag)
#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)
# summary(Report_Compile_Lag)
```


##### 3.6 Okay, lets add up the lags

All created by adding or subtracting from the naturalization year
```{r}
sim_spp1$Intro_Year <- sim_spp1$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp1$Detect_Year <- sim_spp1$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp1$Voucher_Year <- sim_spp1$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag #+ Detect_Vouch_Lag$Detect_Vouch_Lag
sim_spp1$ID_Year <- sim_spp1$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag + Vouch_ID_Lag$Vouch_ID_Lag
sim_spp1$Report_Year <- sim_spp1$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag


sim_spp1$Compile_Year <- sim_spp1$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp1$All_Processing_Lags <- Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp1 <- sim_spp1 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
```



What's the lags look like for all species
```{r}
#plotting histogram
ggplot(sim_spp1, aes(x = All_Processing_Lags)) +
  geom_density(fill="#440154FF", color="#e9ecef", alpha=0.6) +
 # scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
theme_light()
```
### Cropping the Dataset because we can't know about species that haven't been reported yet

You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp1_crop <- subset(sim_spp1, Report_Year < 2020)
#sim_spp1_crop <- sim_spp1
```


## Step 4. Analyse Trends - A) Voucher Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp1_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)
```
## Step 5. Analyse Trends - B) Report Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp1_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
```

## Step 6. Analyse Trends - C) Intro Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp1_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)
#year_count

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
```

## Step 6. Analyse Trends - D) Compiled Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp1_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)
#accumulated_D
```


#### Changepoint - Evidence Collection

```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(a1, diagnostic = TRUE)
```
```{r}
# selectedcp = 4
# changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
# ts = selectedcp)
```
```{r}
changepoint::cpts.full(a1) + (accumulated_A$Year[1] -1)
```
```{r}
firstrow = 3
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + accumulated_A$Year[1]
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 3
endptindex = 4

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp1) -nrow(sim_spp1_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]
```


```{r}
changepoint::plot(a2, type='p')
```


#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 3
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
firstrow = 3
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 3, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

#these may have to be adjusted.
startptindex = 1
endptindex = 2

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp1) -nrow(sim_spp1_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```

```{r}
#making into a single dataframe
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
```



```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(No_Taxa), group = Analysis_Type, color = Analysis_Type)) +
  geom_smooth( size=1.3, alpha=0.8, level = 0, method = "loess", fullrange=TRUE) +
  scale_color_viridis(discrete = TRUE) +
  scale_x_continuous(breaks = c(1920, 1940, 1960, 1980, 2000, 2020)) +
  guides(colour = guide_legend(reverse=T)) +
 theme_light() +
  labs(title = "Scenario1 Nat Rate", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Scenario1_ rate_2025.png", device = "png", scale = 1, width =6, dpi = 600)
```


```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")
DATA$Scenario <- "Both lag types constant"
alllagsconstant <- DATA

# Get more colors than needed so we can discard bad ones
all_colors <- viridis(4, option = "D")

n_colors <- length(unique(DATA$Analysis_Type))

# Filter out the very lightest color (often at the end)
# You can tweak this filter logic â€” here we drop colors with high brightness
drop_yellowish <- function(col_vec, n_keep) {
  rgb_vals <- col2rgb(col_vec)
  brightness <- apply(rgb_vals, 2, mean)  # crude brightness
  keep_indices <- order(brightness)[1:n_keep]
  col_vec[keep_indices]
}

# Keep just the best contrasting n colors
my_colors <- drop_yellowish(all_colors, n_colors)



#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.70) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900, 1920, 1940, 1960, 1980, 2000, 2020)) +
  #guides(colour = guide_legend(reverse=T)) +
 theme_light() +
  theme(legend.title=element_blank(), legend.position="right", panel.border = element_blank()) +
  labs(title = "A:  Lag Lengths Constant \n Over Time", x = "Year", y = "Total naturalized species")
ggsave(filename = "Fig3_ConstantLagScenario_2025.png", device = "png", scale = 1, width =6, dpi = 600)
```



## SCENARIO 2: DATA PROCESSING LAGS ARE CONSTANTLY DECREASING OVER TIME

```{r}
sim_spp2 <- sim_spp
```

##### 3.0
Simulate the lag between introduction and naturalization

```{r}
shape = 1.3
rate = 0.15
```


```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)

```


##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
#shape = 1.3
#rate = 0.15

set.seed(NULL)
Nat_Detect_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate))) *2

colnames(Nat_Detect_Lag) <- "Nat_Detect_Lag"
Nat_Detect_Lag <- subset(Nat_Detect_Lag, Nat_Detect_Lag >=0 & Nat_Detect_Lag <=500)
Nat_Detect_Lag <- as.data.frame(sample(Nat_Detect_Lag$Nat_Detect_Lag, 1000))
colnames(Nat_Detect_Lag) <- "Nat_Detect_Lag"
ave(Nat_Detect_Lag)
#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)
```

##### 3.3
third, simulate the lag between vouchering and identification
this is where it starts to increase


```{r}
set.seed(NULL)

alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

# Create a sequence of shape parameters declining steadily
alltheshapes <- as.data.frame(seq(from = 1.3, to = 0.65, length.out = nrow(alltheyears)))
colnames(alltheshapes) <- "shape"

# Use a fixed rate or create your own sequence like above
alltherates  <- data.frame(rate  = seq(from = 0.15,  to = 0.3, length.out = nrow(alltheyears)))  # You can vary this too
colnames(alltherates) <- "rate"

# Combine into a parameter data frame
paramdf <- cbind(alltheyears, alltheshapes, alltherates)

# Merge with your main data frame
paramdf <- merge(sim_spp2, paramdf, by.x = "Naturalization_Year", by.y = "Year", all.x = TRUE, all.y = FALSE) %>%
  dplyr::select(Naturalization_Year, shape, rate)

# Define new lag function for gamma
get_lag <- function(shape, rate) {
  sample(round(rgamma(1000, shape = shape, rate = rate)), 1)
}

# Apply it
Vouch_ID_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Vouch_ID_Lag <- as.data.frame(Vouch_ID_Lag)


#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)
```



```{r}
set.seed(NULL)
# Apply it
ID_Report_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
ID_Report_Lag <- as.data.frame(ID_Report_Lag)


#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)

```

##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years


```{r}
set.seed(NULL)
# Apply it
Report_Compile_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Report_Compile_Lag <- as.data.frame(Report_Compile_Lag)


#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)

```

So, it may be arbitrary, but the report would compile all species up to that date.

##### 3.6 Okay, lets add up the lags


All created by adding or subtracting from the naturalization year
```{r}
sim_spp2$Intro_Year <- sim_spp2$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp2$Detect_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp2$Voucher_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag #+ Detect_Vouch_Lag$Detect_Vouch_Lag
sim_spp2$ID_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag
sim_spp2$Report_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
sim_spp2$Compile_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp2$All_Processing_Lags <- Intro_Nat_Lag$Intro_Nat_Lag + Nat_Detect_Lag$Nat_Detect_Lag + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp2 <- sim_spp2 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
sim_spp2
```

### Cropping the Dataset because we can't know about species that haven't been reported yet

What's the lags look like for all species
# ```{r}
# #plotting histogram
# ggplot(sim_spp2, aes(x = All_Processing_Lags)) +
#   geom_density(fill="#440154FF", color="#e9ecef", alpha=0.6) +
#  # scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
#theme_light()
# ```
You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp2_crop <- subset(sim_spp2, Report_Year < 2020)
tail(sim_spp2_crop, 2)
```

How many species did we lose that hadn't been reported yet?

```{r}
nrow(sim_spp2) -nrow(sim_spp2_crop)
```

#### Show the number of first records over time, if the researcher were unaware of the unreported species and didn't truncate the time window


## Step 4. Analyse Trends - A) Voucher Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp2_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)

```


## Step 5. Analyse Trends - B) Report Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp2_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
```


## Step 6. Analyse Trends - C) Intro Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp2_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
```

## Step 6. Analyse Trends - D) Compiled Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp2_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)

```

#### Changepoints - Voucher Year


```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(a1, diagnostic = TRUE)
```
```{r}
selectedcp = 4
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(a1, ncpts = selectedcp)
```
```{r}
changepoint::cpts.full(a1) + (accumulated_A$Year[1] -1)
```
```{r}
firstrow = 4
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + accumulated_A$Year[1]
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```


```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 3
endptindex = 4

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp2) -nrow(sim_spp2_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]
```
```{r}
changepoint::plot(a2, type='p')
```

#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 4
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
firstrow = 5
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 2
endptindex = 3

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp2) -nrow(sim_spp2_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```


```{r}
#making into a single dataframe so I can graph it
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
accumulated_A_B_C_D
```

```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")


DATA$Scenario <- "Data processing lags shorten"
dplagsshorten <- DATA

#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.70) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900, 1920, 1940, 1960, 1980, 2000, 2020)) +
  # guides(colour = guide_legend(reverse=T)) +
  theme_light() +
  theme(legend.title=element_blank(), legend.position = "none", panel.border = element_blank()) +
  labs(title = "C:  Data Processing Lags Shorten \n Over Time", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Fig3_DPlagsshorten_2025.png", device = "png", scale = 1, width =4, dpi = 600)
```


## SCENARIO 2: DATA PROCESSING LAGS ARE CONSTANTLY INCREASING OVER TIME

```{r}
sim_spp2 <- sim_spp
```

##### 3.0
Simulate the lag between introduction and naturalization

```{r}
shape = 1.3
rate = 0.15
```

```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)

```


##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
#shape = 1.3
#rate = 0.15

set.seed(NULL)
Nat_Detect_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate))) *2

colnames(Nat_Detect_Lag) <- "Nat_Detect_Lag"
Nat_Detect_Lag <- subset(Nat_Detect_Lag, Nat_Detect_Lag >=0 & Nat_Detect_Lag <=500)
Nat_Detect_Lag <- as.data.frame(sample(Nat_Detect_Lag$Nat_Detect_Lag, 1000))
colnames(Nat_Detect_Lag) <- "Nat_Detect_Lag"
ave(Nat_Detect_Lag)
#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)
```

##### 3.3
third, simulate the lag between vouchering and identification
this is where it starts to increase


```{r}
set.seed(NULL)

alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

# Create a sequence of shape parameters declining steadily
alltheshapes <- as.data.frame(seq(from = 1.3 , to = 1.75, length.out = nrow(alltheyears)))
colnames(alltheshapes) <- "shape"

# Use a fixed rate or create your own sequence like above
alltherates  <- data.frame(rate  = seq(from = 0.15,  to = 0.11, length.out = nrow(alltheyears)))  # You can vary this too
colnames(alltherates) <- "rate"

# Combine into a parameter data frame
paramdf <- cbind(alltheyears, alltheshapes, alltherates)

# Merge with your main data frame
paramdf <- merge(sim_spp2, paramdf, by.x = "Naturalization_Year", by.y = "Year", all.x = TRUE, all.y = FALSE) %>%
  dplyr::select(Naturalization_Year, shape, rate)

# Define new lag function for gamma
get_lag <- function(shape, rate) {
  sample(round(rgamma(1000, shape = shape, rate = rate)), 1)
}

# Apply it
Vouch_ID_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Vouch_ID_Lag <- as.data.frame(Vouch_ID_Lag)


#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)
```


##### 3.3
third, simulate the lag between identification & reporting
this is where it starts to increase constantly



```{r}
set.seed(NULL)
# Apply it
ID_Report_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
ID_Report_Lag <- as.data.frame(ID_Report_Lag)


#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)

```

##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years

```{r}
set.seed(NULL)
# Apply it
Report_Compile_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Report_Compile_Lag <- as.data.frame(Report_Compile_Lag)


#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)

```

So, it may be arbitrary, but the report would compile all species up to that date.



##### 3.6 Okay, lets add up the lags


All created by adding or subtracting from the naturalization year
```{r}
sim_spp2$Intro_Year <- sim_spp2$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp2$Detect_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp2$Voucher_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp2$ID_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag
sim_spp2$Report_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
sim_spp2$Compile_Year <- sim_spp2$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp2$All_Processing_Lags <- Intro_Nat_Lag$Intro_Nat_Lag + Nat_Detect_Lag$Nat_Detect_Lag + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp2 <- sim_spp2 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
sim_spp2
```

### Cropping the Dataset because we can't know about species that haven't been reported yet

You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp2_crop <- subset(sim_spp2, Report_Year < 2020)
tail(sim_spp2_crop, 2)
```

How many species did we lose that hadn't been reported yet?

```{r}
nrow(sim_spp2) -nrow(sim_spp2_crop)
```

#### Show the number of first records over time, if the researcher were unaware of the unreported species and didn't truncate the time window


## Step 4. Analyse Trends - A) Voucher Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp2_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)

```


## Step 5. Analyse Trends - B) Report Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp2_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
```


## Step 6. Analyse Trends - C) Intro Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp2_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
```

## Step 6. Analyse Trends - D) Compiled Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp2_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)

```

#### Changepoints - Voucher Year


```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

a1
#plot(a1, ncpts = 3, diagnostic = TRUE)
```

```{r}
selectedcp = 3
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(a1, ncpts = selectedcp)
```
```{r}
changepoint::cpts.full(a1) + (accumulated_A$Year[1] -1)
```
```{r}
firstrow = 5
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + accumulated_A$Year[1]
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]


startptindex = 3
endptindex = 4

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp2) -nrow(sim_spp2_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]
```
```{r}
changepoint::plot(a2, type='p')
```



#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 5
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
accumulated_C$Taxa_Introduced
```
had to set firstrow to 6!!! 

```{r}
firstrow = 6.5
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]


startptindex = 2
endptindex = 3

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp2) -nrow(sim_spp2_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```


```{r}
#making into a single dataframe so I can graph it
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
accumulated_A_B_C_D
```


```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")


DATA$Scenario <- "Data processing lags lengthen"
dplagslengthen <- DATA


# Get more colors than needed so we can discard bad ones
all_colors <- viridis(4, option = "D")

n_colors <- length(unique(DATA$Analysis_Type))

# Filter out the very lightest color (often at the end)
# You can tweak this filter logic â€” here we drop colors with high brightness
drop_yellowish <- function(col_vec, n_keep) {
  rgb_vals <- col2rgb(col_vec)
  brightness <- apply(rgb_vals, 2, mean)  # crude brightness
  keep_indices <- order(brightness)[1:n_keep]
  col_vec[keep_indices]
}

# Keep just the best contrasting n colors
my_colors <- drop_yellowish(all_colors, n_colors)

#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.70) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900, 1920, 1940, 1960, 1980, 2000, 2020)) +
 #  guides(colour = guide_legend(reverse=T)) +
  theme_light() +
  theme(legend.title=element_blank(), legend.position = "none", panel.border = element_blank()) +
  labs(title = "F:  Data Processing Lags Lengthen \n Over Time", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Fig3_DPlagslengthen_2025.png", device = "png", scale = 1, width =4, dpi = 600)
```




## SCENARIO 3: FIELD SURVEYING LAGS ARE DECREASING OVER TIME

For this scenario, let's say that the sum of all the lags is somewhere between 0 and about 15 years, with most species having a total lag time of 5-7 years and a lag time of 0 isn't really possible

```{r}
sim_spp3 <- sim_spp
```


##### 3.0
Simulate the lag between introduction and naturalization

```{r}
shape = 1.3
rate = 0.15
```

```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)

```


##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
set.seed(NULL)

alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

# Create a sequence of shape parameters declining steadily
alltheshapes <- as.data.frame(seq(from = 1.3, to = 0.65, length.out = nrow(alltheyears)))
colnames(alltheshapes) <- "shape"

# Use a fixed rate or create your own sequence like above
alltherates  <- data.frame(rate  = seq(from = 0.15,  to = 0.3, length.out = nrow(alltheyears)))  # You can vary this too
colnames(alltherates) <- "rate"


# Combine into a parameter data frame
paramdf <- cbind(alltheyears, alltheshapes, alltherates)

# Merge with your main data frame
paramdf <- merge(sim_spp2, paramdf, by.x = "Naturalization_Year", by.y = "Year", all.x = TRUE, all.y = FALSE) %>%
  dplyr::select(Naturalization_Year, shape, rate)

# Define new lag function for gamma
get_lag <- function(shape, rate) {
  sample(round(rgamma(1000, shape = shape, rate = rate)), 1)
}

# Apply it
Nat_Detect_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag) *2
Nat_Detect_Lag <- as.data.frame(Nat_Detect_Lag)


#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)
```


##### 3.2
Second, simulate the lag between detection and evidence collection

third, simulate the lag between vouchering and identification
this is where it starts to increase

```{r}
set.seed(NULL)
test <-rgamma(n = 100, shape = 0.30, rate = .8)
summary(test)
hist(test)
```

```{r}
set.seed(NULL)
Vouch_ID_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Vouch_ID_Lag) <- "Vouch_ID_Lag"
Vouch_ID_Lag <- subset(Vouch_ID_Lag, Vouch_ID_Lag >=0 & Vouch_ID_Lag <=500)
Vouch_ID_Lag <- as.data.frame(sample(Vouch_ID_Lag$Vouch_ID_Lag, 1000))
colnames(Vouch_ID_Lag) <- "Vouch_ID_Lag"
ave(Vouch_ID_Lag)
#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)

```


##### 3.3
third, simulate the lag between identification & reporting
this is where it starts to increase constantly


```{r}
set.seed(NULL)
ID_Report_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(ID_Report_Lag) <- "ID_Report_Lag"
ID_Report_Lag <- subset(ID_Report_Lag, ID_Report_Lag >=0 & ID_Report_Lag <=500)
ID_Report_Lag <- as.data.frame(sample(ID_Report_Lag$ID_Report_Lag, 1000))
colnames(ID_Report_Lag) <- "ID_Report_Lag"
ave(ID_Report_Lag)
#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)

```

##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years


```{r}
set.seed(NULL)
# Apply it
Report_Compile_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Report_Compile_Lag <- as.data.frame(Report_Compile_Lag)


#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)

```

So, it may be arbitrary, but the report would compile all species up to that date.


##### 3.6 Okay, lets add up the lags
So, the timing of the collected voucher AND final "new record report" is just the year the species naturalized + 0,

All created by adding or subtracting from the naturalization year
```{r}
sim_spp3$Intro_Year <- sim_spp3$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp3$Detect_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp3$Voucher_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp3$ID_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag +  Vouch_ID_Lag$Vouch_ID_Lag
sim_spp3$Report_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
sim_spp3$Compile_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp3$All_Processing_Lags <- Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp3 <- sim_spp3 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
#sim_spp3
```

### Cropping the Dataset because we can't know about species that haven't been reported yet

What's the lags look like for all species
```{r}
# #plotting histogram
# ggplot(sim_spp3, aes(x = All_Processing_Lags)) +
#   geom_density(fill="#440154FF", color="#e9ecef", alpha=0.6) +
#  # scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10)) +
#theme_light()
```


You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp3_crop <- subset(sim_spp3, Report_Year < 2020)
```

How many species did we lose that hadn't been reported yet?

```{r}
nrow(sim_spp3) -nrow(sim_spp3_crop)
```

## Step 4. Analyse Trends - A) Voucher Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp3_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)
#accumulated_A
```

## Step 5. Analyse Trends - B) Report Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp3_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
#accumulated_B
```

## Step 6. Analyse Trends - C) Intro Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp3_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
#accumulated_C
```


## Step 6. Analyse Trends - D) Compiled Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp3_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)
#accumulated_D
```

#### Changepoints - Voucher Year

```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(a1, diagnostic = TRUE)
```
```{r}
selectedcp = 4
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(a1, ncpts = selectedcp)
```
```{r}
changepoint::cpts.full(a1) + (accumulated_A$Year[1] -1)
```
```{r}
firstrow = 5
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + accumulated_A$Year[1]
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]


startptindex = 3
endptindex = 4

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp3) -nrow(sim_spp3_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]

```
```{r}
changepoint::plot(a2, type='p')
```


#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 3
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
firstrow = 5
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 2
endptindex = 3

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp3) -nrow(sim_spp3_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```



```{r}
#making into a single dataframe
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
```


```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")

DATA$Scenario <- "Field surveying lags shorten"
fslagsshorten <- DATA


# Get more colors than needed so we can discard bad ones
all_colors <- viridis(4, option = "D")

n_colors <- length(unique(DATA$Analysis_Type))

# Filter out the very lightest color (often at the end)
# You can tweak this filter logic â€” here we drop colors with high brightness
drop_yellowish <- function(col_vec, n_keep) {
  rgb_vals <- col2rgb(col_vec)
  brightness <- apply(rgb_vals, 2, mean)  # crude brightness
  keep_indices <- order(brightness)[1:n_keep]
  col_vec[keep_indices]
}

# Keep just the best contrasting n colors
my_colors <- drop_yellowish(all_colors, n_colors)


#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.7) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900, 1920, 1940, 1960, 1980, 2000, 2020)) +
#   guides(colour = guide_legend(reverse=T)) +
theme_light() +
  theme(legend.title=element_blank(), legend.position = "none", panel.border = element_blank()) +
  labs(title = "B: Field Surveying Lags Shorten \n Over Time", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Fig3_SteadyShortenFieldLags_2025.png", device = "png", scale = 1, width =4, dpi = 600)
```


## SCENARIO 3: FIELD SURVEYING LAGS ARE Lengthening OVER TIME

For this scenario, let's say that the sum of all the lags is somewhere between 0 and about 15 years, with most species having a total lag time of 5-7 years and a lag time of 0 isn't really possible

```{r}
sim_spp3 <- sim_spp
```

##### 3.0
Simulate the lag between introduction and naturalization

```{r}
shape = 1.3
rate = 0.15
```

```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)

```


##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
set.seed(NULL)

alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

# Create a sequence of shape parameters declining steadily
alltheshapes <- as.data.frame(seq(from = 1.3 , to = 1.75, length.out = nrow(alltheyears)))
colnames(alltheshapes) <- "shape"

# Use a fixed rate or create your own sequence like above
alltherates  <- data.frame(rate  = seq(from = 0.15,  to = 0.11, length.out = nrow(alltheyears)))  # You can vary this too
colnames(alltherates) <- "rate"


# Combine into a parameter data frame
paramdf <- cbind(alltheyears, alltheshapes, alltherates)

# Merge with your main data frame
paramdf <- merge(sim_spp2, paramdf, by.x = "Naturalization_Year", by.y = "Year", all.x = TRUE, all.y = FALSE) %>%
  dplyr::select(Naturalization_Year, shape, rate)

# Define new lag function for gamma
get_lag <- function(shape, rate) {
  sample(round(rgamma(1000, shape = shape, rate = rate)), 1)
}

# Apply it
Nat_Detect_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag) *2
Nat_Detect_Lag <- as.data.frame(Nat_Detect_Lag)


#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)
```


##### 3.3
third, simulate the lag between vouchering and identification
this is where it starts to increase

```{r}
set.seed(NULL)
test <-rgamma(n = 1000, shape = 1.3, rate = 0.15)
summary(test)
#hist(test)
```

```{r}
set.seed(NULL)
Vouch_ID_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Vouch_ID_Lag) <- "Vouch_ID_Lag"
Vouch_ID_Lag <- subset(Vouch_ID_Lag, Vouch_ID_Lag >=0 & Vouch_ID_Lag <=500)
Vouch_ID_Lag <- as.data.frame(sample(Vouch_ID_Lag$Vouch_ID_Lag, 1000))
colnames(Vouch_ID_Lag) <- "Vouch_ID_Lag"
ave(Vouch_ID_Lag)
#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)

```


##### 3.3
third, simulate the lag between identification & reporting
this is where it starts to increase constantly


```{r}
set.seed(NULL)
ID_Report_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(ID_Report_Lag) <- "ID_Report_Lag"
ID_Report_Lag <- subset(ID_Report_Lag, ID_Report_Lag >=0 & ID_Report_Lag <=500)
ID_Report_Lag <- as.data.frame(sample(ID_Report_Lag$ID_Report_Lag, 1000))
colnames(ID_Report_Lag) <- "ID_Report_Lag"
ave(ID_Report_Lag)
#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)

```

##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years


```{r}
set.seed(NULL)
# Apply it
Report_Compile_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Report_Compile_Lag <- as.data.frame(Report_Compile_Lag)


#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)

```

So, it may be arbitrary, but the report would compile all species up to that date.

##### 3.6 Okay, lets add up the lags
So, the timing of the collected voucher AND final "new record report" is just the year the species naturalized + 0,

All created by adding or subtracting from the naturalization year
```{r}
sim_spp3$Intro_Year <- sim_spp3$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp3$Detect_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp3$Voucher_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp3$ID_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag
sim_spp3$Report_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
sim_spp3$Compile_Year <- sim_spp3$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp3$All_Processing_Lags <- Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp3 <- sim_spp3 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
#sim_spp3
```

### Cropping the Dataset because we can't know about species that haven't been reported yet


You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp3_crop <- subset(sim_spp3, Report_Year < 2020)
```

How many species did we lose that hadn't been reported yet?

```{r}
nrow(sim_spp3) -nrow(sim_spp3_crop)
```

## Step 4. Analyse Trends - A) Voucher Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp3_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)
#accumulated_A
```

## Step 5. Analyse Trends - B) Report Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp3_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
#accumulated_B
```

## Step 6. Analyse Trends - C) Intro Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp3_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
#accumulated_C
```


## Step 6. Analyse Trends - D) Compiled Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp3_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)
#accumulated_D
```

#### Changepoints - Voucher Year

```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(a1, diagnostic = TRUE)
```
```{r}
selectedcp = 4
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(a1, ncpts = selectedcp)
```

```{r}
str(accumulated_A$Year)
```

```{r}
changepoint::cpts.full(a1) + (as.numeric(accumulated_A$Year[1]) -1)
```
```{r}
firstrow = 5
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + as.numeric(accumulated_A$Year[1])
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 1
endptindex = 2

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp3) -nrow(sim_spp3_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]

```
```{r}
changepoint::plot(a2, type='p')
```


#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 3
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
firstrow = 4
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 2
endptindex = 3

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp3) -nrow(sim_spp3_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```



```{r}
#making into a single dataframe
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
```

```{r}
# DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
# DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
# #plotting total species accumulation over time
# ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(No_Taxa), group = Analysis_Type, color = Analysis_Type)) +
#   geom_smooth( size=1.3, alpha=0.8, level = 0, method = "loess", fullrange=TRUE) +
#   scale_color_viridis(discrete = TRUE) +
#   scale_x_continuous(breaks = c(1920, 1940, 1960, 1980, 2000, 2020)) +
#  theme_light() +
#   labs(title = "Scenario 3 Nat Rate", x = "Year", y = "Total Naturalized Species")
# ggsave(filename = "Scenario3_ rate_2025.png", device = "png", scale = 1, width =6, dpi = 600)
```

```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")

DATA$Scenario <- "Field surveying lags lengthen"
fslagslengthen <- DATA


# Get more colors than needed so we can discard bad ones
all_colors <- viridis(4, option = "D")

n_colors <- length(unique(DATA$Analysis_Type))

# Filter out the very lightest color (often at the end)
# You can tweak this filter logic â€” here we drop colors with high brightness
drop_yellowish <- function(col_vec, n_keep) {
  rgb_vals <- col2rgb(col_vec)
  brightness <- apply(rgb_vals, 2, mean)  # crude brightness
  keep_indices <- order(brightness)[1:n_keep]
  col_vec[keep_indices]
}

# Keep just the best contrasting n colors
my_colors <- drop_yellowish(all_colors, n_colors)

#plotting total species accumulation over time1
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.7) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900, 1920, 1940, 1960, 1980, 2000, 2020)) +
  # guides(colour = guide_legend(reverse=T)) +
theme_light() +
  theme(legend.title=element_blank(), legend.position = "none", panel.border = element_blank()) +
  labs(title = "E:  Field Surveying Lags Lengthen \n Over Time", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Fig3_SteadylengthenFieldLags_2025.png", device = "png", scale = 1, width =4, dpi = 600)
```


## SCENARIO 4: BOTH FIELD SURVEYING & DATA PROCESSING LAGS ARE DECREASING OVER TIME

For this scenario, let's say that the sum of all the lags is somewhere between 0 and about 15 years, with most species having a total lag time of 5-7 years and a lag time of 0 isn't really possible

```{r}
sim_spp4 <- sim_spp
#sim_spp4
```

##### 3.0
Simulate the lag between introduction and naturalization

```{r}
shape = 1.3
rate = 0.15
```

```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)

```
```{r}
set.seed(NULL)
test <-rgamma(n = 100, shape = 0.30, rate = 0.05)
summary(test)
hist(test)
```
```{r}
set.seed(NULL)
test <-rgamma(n = 100, shape = 1.3, rate = 0.15)
summary(test)
hist(test)
```

##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
set.seed(NULL)

alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"


# Create a sequence of shape parameters declining steadily
alltheshapes <- as.data.frame(seq(from = 1.3, to = 0.65, length.out = nrow(alltheyears)))
colnames(alltheshapes) <- "shape"

# Use a fixed rate or create your own sequence like above
alltherates  <- data.frame(rate  = seq(from = 0.15,  to = 0.3, length.out = nrow(alltheyears)))  # You can vary this too
colnames(alltherates) <- "rate"


# Combine into a parameter data frame
paramdf <- cbind(alltheyears, alltheshapes, alltherates)

# Merge with your main data frame
paramdf <- merge(sim_spp2, paramdf, by.x = "Naturalization_Year", by.y = "Year", all.x = TRUE, all.y = FALSE) %>%
  dplyr::select(Naturalization_Year, shape, rate)

# Define new lag function for gamma
get_lag <- function(shape, rate) {
  sample(round(rgamma(1000, shape = shape, rate = rate)), 1)
}

# Apply it
Nat_Detect_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag) *2
Nat_Detect_Lag <- as.data.frame(Nat_Detect_Lag)


#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)
```


#
##### 3.3
third, simulate the lag between vouchering and identification
this is where it starts to increase



```{r}

# Apply it
Vouch_ID_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Vouch_ID_Lag <- as.data.frame(Vouch_ID_Lag)


#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)

```


##### 3.3
third, simulate the lag between identification & reporting
this is where it starts to increase constantly


```{r}
# Apply it
ID_Report_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
ID_Report_Lag <- as.data.frame(ID_Report_Lag)


#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)

```

##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years


```{r}
set.seed(NULL)
# Apply it
Report_Compile_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Report_Compile_Lag <- as.data.frame(Report_Compile_Lag)


#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)

```

So, it may be arbitrary, but the report would compile all species up to that date.


##### 3.6 Okay, lets add up the lags
So, the timing of the collected voucher AND final "new record report" is just the year the species naturalized + 0,


All created by adding or subtracting from the naturalization year
```{r}
sim_spp4$Intro_Year <- sim_spp4$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp4$Detect_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp4$Voucher_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp4$ID_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag
sim_spp4$Report_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag


sim_spp4$Compile_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp4$All_Processing_Lags <- Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp4 <- sim_spp4 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
head(sim_spp4,2)
```

### Cropping the Dataset because we can't know about species that haven't been reported yet




You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp4_crop <- subset(sim_spp4, Report_Year <= 2020)
```

How many species did we lose that hadn't been reported yet?

```{r}
nrow(sim_spp4) -nrow(sim_spp4_crop)
```

## Step 4. Analyse Trends - A) Voucher Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp4_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)
#accumulated_A
```

## Step 5. Analyse Trends - B) Report Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp4_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
#accumulated_B
```

## Step 6. Analyse Trends - C) Intro Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2020))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp4_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
#accumulated_C
```


## Step 6. Analyse Trends - D) Compiled Year
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2020))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp4_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)
#accumulated_D
```

#### Changepoints - Voucher Year

```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(a1, diagnostic = TRUE)
```
```{r}
selectedcp = 3
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(a1, ncpts = selectedcp)
```
```{r}
accumulated_A$Year <- as.numeric(accumulated_A$Year)
changepoint::cpts.full(a1) + (accumulated_A$Year[1] -1)
```



```{r}
firstrow = 5
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + accumulated_A$Year[1]
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 3
endptindex = 4

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp4) -nrow(sim_spp4_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]

```
```{r}
changepoint::plot(a2, type='p')
```



#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 4
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
firstrow = 3
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 2
endptindex = 3

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp4) -nrow(sim_spp4_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```




```{r}
#making into a single dataframe
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
accumulated_A_B_C_D
```


```{r}
# DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
# DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
# #plotting total species accumulation over time
# ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(No_Taxa), group = Analysis_Type, color = Analysis_Type)) +
#   geom_smooth( size=1.3, alpha=0.8, level = 0, method = "loess", fullrange=TRUE) +
#   scale_color_viridis(discrete = TRUE) +
#   scale_x_continuous(breaks = c(1920, 1940, 1960, 1980, 2000, 2020)) +
#    guides(colour = guide_legend(reverse=T)) +
#  theme_light() +
#   labs(title = "Scenario 2 Nat Rate", x = "Year", y = "Total Naturalized Species")
# ggsave(filename = "Scenario2_ rate_2025.png", device = "png", scale = 1, width =6, dpi = 600)
```

```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")

DATA$Scenario <- "Both lag types shorten"
dp_fslagsshorten <- DATA


# Get more colors than needed so we can discard bad ones
all_colors <- viridis(4, option = "D")

n_colors <- length(unique(DATA$Analysis_Type))

# Filter out the very lightest color (often at the end)
# You can tweak this filter logic â€” here we drop colors with high brightness
drop_yellowish <- function(col_vec, n_keep) {
  rgb_vals <- col2rgb(col_vec)
  brightness <- apply(rgb_vals, 2, mean)  # crude brightness
  keep_indices <- order(brightness)[1:n_keep]
  col_vec[keep_indices]
}

# Keep just the best contrasting n colors
my_colors <- drop_yellowish(all_colors, n_colors)


#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.7) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900,1920, 1940, 1960, 1980, 2000, 2020)) +
 theme_light() +
  theme(legend.title=element_blank(), legend.position = "none", panel.border = element_blank()) +
  labs(title = "D:  Field Surveying & Data Processing \n Lags Shorten Over Time", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Fig3_FSandDP_steadyshorten_2025.png", device = "png", scale = 1, width =4, dpi = 600)
```





## SCENARIO 4: BOTH FIELD SURVEYING & DATA PROCESSING LAGS ARE DECREASING OVER TIME

For this scenario, let's say that the sum of all the lags is somewhere between 0 and about 15 years, with most species having a total lag time of 5-7 years and a lag time of 0 isn't really possible

```{r}
sim_spp4 <- sim_spp
#sim_spp4
```



##### 3.0
Simulate the lag between introduction and naturalization

```{r}
shape = 1.3
rate = 0.15
```

```{r}
set.seed(NULL)
Intro_Nat_Lag <- as.data.frame(round(rgamma(n = 10000, shape = shape, rate = rate)))

colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
Intro_Nat_Lag <- subset(Intro_Nat_Lag, Intro_Nat_Lag >=0 & Intro_Nat_Lag <=500)
Intro_Nat_Lag <- as.data.frame(sample(Intro_Nat_Lag$Intro_Nat_Lag, 1000))
colnames(Intro_Nat_Lag) <- "Intro_Nat_Lag"
ave(Intro_Nat_Lag)
#plotting histogram
ggplot(Intro_Nat_Lag, aes(x = Intro_Nat_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Intro_Nat_Lag)

```



##### 3.1
Then, simulate the lag between naturalization and detection

```{r}
set.seed(NULL)

alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

# Create a sequence of shape parameters declining steadily
alltheshapes <- as.data.frame(seq(from = 1.30 , to = 1.75, length.out = nrow(alltheyears)))
colnames(alltheshapes) <- "shape"

# Use a fixed rate or create your own sequence like above
alltherates  <- data.frame(rate  = seq(from = 0.15,  to = 0.11, length.out = nrow(alltheyears)))  # You can vary this too
colnames(alltherates) <- "rate"


# Combine into a parameter data frame
paramdf <- cbind(alltheyears, alltheshapes, alltherates)

# Merge with your main data frame
paramdf <- merge(sim_spp2, paramdf, by.x = "Naturalization_Year", by.y = "Year", all.x = TRUE, all.y = FALSE) %>%
  dplyr::select(Naturalization_Year, shape, rate)

# Define new lag function for gamma
get_lag <- function(shape, rate) {
  sample(round(rgamma(1000, shape = shape, rate = rate)), 1)
}

# Apply it
Nat_Detect_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag) *2
Nat_Detect_Lag <- as.data.frame(Nat_Detect_Lag)


#plotting histogram
ggplot(Nat_Detect_Lag, aes(x = Nat_Detect_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Nat_Detect_Lag)
```



##### 3.3
third, simulate the lag between vouchering and identification
this is where it starts to increase

```{r}
set.seed(NULL)
test <-rgamma(n = 100, shape = 0.30, rate = .8)
summary(test)
hist(test)
```

```{r}

# Apply it
Vouch_ID_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Vouch_ID_Lag <- as.data.frame(Vouch_ID_Lag)


#plotting histogram
ggplot(Vouch_ID_Lag, aes(x = Vouch_ID_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Vouch_ID_Lag)

```


##### 3.3
third, simulate the lag between identification & reporting
this is where it starts to increase constantly


```{r}
# Apply it
ID_Report_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
ID_Report_Lag <- as.data.frame(ID_Report_Lag)


#plotting histogram
ggplot(ID_Report_Lag, aes(x = ID_Report_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(ID_Report_Lag)

```

##### 3.5
Then, simulate the lag between reporting  and when someone makes a resource that is compiled and formatted
let's say this takes around 2 years, with some taking longer, up to 10 years


```{r}
set.seed(NULL)
# Apply it
Report_Compile_Lag <- mapply(shape = paramdf$shape, rate = paramdf$rate, FUN = get_lag)
Report_Compile_Lag <- as.data.frame(Report_Compile_Lag)


#plotting histogram
ggplot(Report_Compile_Lag, aes(x = Report_Compile_Lag)) +
  geom_histogram(binwidth = 1) +
theme_light()
summary(Report_Compile_Lag)

```

So, it may be arbitrary, but the report would compile all species up to that date.

##### 3.6 Okay, lets add up the lags
So, the timing of the collected voucher AND final "new record report" is just the year the species naturalized + 0,


All created by adding or subtracting from the naturalization year
```{r}
sim_spp4$Intro_Year <- sim_spp4$Naturalization_Year - Intro_Nat_Lag$Intro_Nat_Lag
sim_spp4$Detect_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag
sim_spp4$Voucher_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag 
sim_spp4$ID_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag
sim_spp4$Report_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag 


sim_spp4$Compile_Year <- sim_spp4$Naturalization_Year + Nat_Detect_Lag$Nat_Detect_Lag  + Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag + Report_Compile_Lag$Report_Compile_Lag


sim_spp4$All_Processing_Lags <- Vouch_ID_Lag$Vouch_ID_Lag + ID_Report_Lag$ID_Report_Lag
#reordering according to Report Year
sim_spp4 <- sim_spp4 %>% dplyr::select(Species_IDNo, Intro_Year, Naturalization_Year, Detect_Year, Voucher_Year, ID_Year, Report_Year, Compile_Year, All_Processing_Lags)
head(sim_spp4,2)
```

### Cropping the Dataset because we can't know about species that haven't been reported yet

You cannot keep all of these species, because hypothetically, it's 2020 and you don't know which species to analyze if they haven't been reported yet
```{r}
sim_spp4_crop <- subset(sim_spp4, Report_Year <= 2020)
```

How many species did we lose that hadn't been reported yet?

```{r}
nrow(sim_spp4) -nrow(sim_spp4_crop)
```

## Step 4. Analyse Trends - A) Voucher Year 
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they we vouchered
year_count <- as.data.frame(table(sim_spp4_crop$Voucher_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Vouchered = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0

#calculating species accumulation over time
accumulated_A <- accumulate(year_count$Taxa_Vouchered, sum)
accumulated_A <- cbind(year_count, accumulated_A)
#accumulated_A 
```

## Step 5. Analyse Trends - B) Report Year 
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2019))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp4_crop$Report_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Reported = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_B <- accumulate(year_count$Taxa_Reported, sum)
accumulated_B <- cbind(year_count, accumulated_B)
#accumulated_B 
```

## Step 6. Analyse Trends - C) Intro Year 
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2020))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp4_crop$Intro_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Introduced = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_C <- accumulate(year_count$Taxa_Introduced, sum)
accumulated_C <- cbind(year_count, accumulated_C)
#accumulated_C 
```


## Step 6. Analyse Trends - D) Compiled Year 
```{r}
#just making a vector of years from 1920 to 2020
alltheyears <- as.data.frame(seq(from = 1920, to = 2020))
colnames(alltheyears) <- "Year"

#grouping my simulated species by the year they were reported
year_count <- as.data.frame(table(sim_spp4_crop$Compile_Year)) %>%
# and renaming columns
  dplyr::rename(Year = Var1, Taxa_Compiled = Freq)

#merging with all the years
year_count <-merge(alltheyears, year_count, all = TRUE)
#making the NA's become 0s, because 0 new species were vouchered in those years
year_count[is.na(year_count)] = 0
#calculating species accumulation over time
accumulated_D <- accumulate(year_count$Taxa_Compiled, sum)
accumulated_D <- cbind(year_count, accumulated_D)
#accumulated_D 
```

#### Changepoints - Voucher Year

```{r}
plot(accumulated_A$Taxa_Vouchered)
```
```{r}
a1 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(a1, diagnostic = TRUE)
```
```{r}
selectedcp = 2
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
#ts = selectedcp)
```
```{r}
changepoint::cpts.full(a1) + (accumulated_A$Year[1] -1)
```
```{r}
firstrow = 4
secondrow = firstrow +1
a2 <- changepoint::cpt.meanvar(accumulated_A$Taxa_Vouchered, penalty = "Manual",  pen.value=((pen.value.full(a1)[firstrow] + pen.value.full(a1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(a2), nrow(accumulated_A))
chpoints
chpoints + accumulated_A$Year[1]
segmeans <- changepoint::param.est(a2)$mean
segmeans
segvars <- (changepoint::param.est(a2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 1
endptindex = 2

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp4) -nrow(sim_spp4_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_A) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_A$Taxa_Vouchered)
chpoints + accumulated_A$Year[1]
```
```{r}
changepoint::plot(a2, type='p')
```



#### Changepoints - Intro Date

```{r}
plot(accumulated_C$Taxa_Introduced)
```
```{r}
c1 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "CROPS",  pen.value=c(5,500), method = "PELT", Q = 25, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

#plot(c1, diagnostic = TRUE)
```
```{r}
selectedcp = 4
#changepoint::plot(a1, cpt.width = 4, col = "black", cpt.col = "blue", ylab = "# of Taxa Vouchered", xlab = "Years (since beginning of time window)")
#changepoint::plot(c1, ncpts = selectedcp)
```

```{r}
changepoint::cpts.full(c1) + as.numeric(accumulated_C$Year[1]) -1
```
```{r}
firstrow = 4
secondrow = firstrow +1
c2 <- changepoint::cpt.meanvar(accumulated_C$Taxa_Introduced, penalty = "Manual",  pen.value=((pen.value.full(c1)[firstrow] + pen.value.full(c1)[secondrow]) /2) , method = "PELT", Q = 10, test.stat = "Normal", class = TRUE, param.estimates = TRUE, minseglen = 5)

chpoints <- c( 0, changepoint::cpts(c2), nrow(accumulated_C))
chpoints
chpoints + as.numeric(accumulated_C$Year[1])
segmeans <- changepoint::param.est(c2)$mean
segmeans
segvars <- (changepoint::param.est(c2)$variance)
sqrt(segvars)
```
```{r}
seg1wmean <- segmeans[1]* (chpoints[2]- chpoints[1])
seg2wmean <- segmeans[2]* (chpoints[3] - chpoints[2])
seg3wmean <- segmeans[3]* (chpoints[4] - chpoints[3])
seg4wmean <- segmeans[4]* (chpoints[5] - chpoints[4])
seg5wmean <- segmeans[5]* (chpoints[6] - chpoints[5])
seg6wmean <- segmeans[6]* (chpoints[7] - chpoints[6])
seg7wmean <- segmeans[7]* (chpoints[8] - chpoints[7])
seg8wmean <- segmeans[8]* (chpoints[9] - chpoints[8])
seg1wvar <- segvars[1]* (chpoints[2]- chpoints[1])
seg2wvar <- segvars[2]* (chpoints[3] - chpoints[2])
seg3wvar <- segvars[3]* (chpoints[4] - chpoints[3])
seg4wvar <- segvars[4]* (chpoints[5] - chpoints[4])
seg5wvar <- segvars[5]* (chpoints[6] - chpoints[5])
seg6wvar <- segvars[6]* (chpoints[7] - chpoints[6])
seg7wvar <- segvars[7]* (chpoints[8] - chpoints[7])
seg7wvar <- segvars[8]* (chpoints[9] - chpoints[8])

segwmeans <- c(seg1wmean, seg2wmean, seg3wmean, seg4wmean, seg5wmean, seg6wmean, seg7wmean)
segwmeans <- segwmeans[!is.na(segwmeans)]
segwvars <- c(seg1wvar, seg2wvar, seg3wvar, seg4wvar, seg5wvar, seg6wvar, seg7wvar)
segwvars <- segwvars[!is.na(segwvars)]

startptindex = 2
endptindex = 3

print("How many species did we lose that hadn't been reported yet?")
spplost <- nrow(sim_spp4) -nrow(sim_spp4_crop)
spplost

print("start seg length, mean, std: ")
chpoints[startptindex]
round(sum(segwmeans[1:(startptindex-1)]) / chpoints[startptindex], 2)
round(sqrt(sum(segwvars[1:(startptindex-1)]) / chpoints[startptindex]), 2)

print("truncated seg length, mean, std:")
chpoints[endptindex] - chpoints[startptindex]
round(sum(segwmeans[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex]), 2)
round(sqrt(sum(segwvars[startptindex:(endptindex -1)]) / (chpoints[endptindex] - chpoints[startptindex])), 2)

print("ending seg length, mean, std:")
nrow(accumulated_C) - chpoints[endptindex]
round(sum(segwmeans[endptindex:length(segwmeans)]) / (chpoints[length(chpoints)]- chpoints[endptindex]), 2)
round(sqrt(sum(segwvars[endptindex:length(segwvars)]) / (chpoints[length(chpoints)]- chpoints[endptindex])), 2)

print("mean of whole, changepoints")
mean(accumulated_C$Taxa_Introduced)
chpoints + as.numeric(accumulated_C$Year[1])
```
```{r}
changepoint::plot(c2, type='p')
```

```{r}
#making into a single dataframe
#accumulated  <- accumulated %>% dplyr::rename(accumulated_species = accumulated, No_Taxa = Taxa_Naturalized)
accumulated_A  <- accumulated_A %>% dplyr::rename(accumulated_species = accumulated_A, No_Taxa = Taxa_Vouchered)
accumulated_B  <- accumulated_B %>% dplyr::rename(accumulated_species = accumulated_B, No_Taxa = Taxa_Reported)
accumulated_C  <- accumulated_C %>% dplyr::rename(accumulated_species = accumulated_C, No_Taxa = Taxa_Introduced)
accumulated_D  <- accumulated_D %>% dplyr::rename(accumulated_species = accumulated_D, No_Taxa = Taxa_Compiled)
accumulated$Analysis_Type <- "True naturalization date"
accumulated_A$Analysis_Type <- "Detection date"
accumulated_B$Analysis_Type <- "Report date"
accumulated_C$Analysis_Type <- "Estimated introduction date"
accumulated_D$Analysis_Type <- "Compiled date"

accumulated_A_B_C_D <- rbind(accumulated, accumulated_A, accumulated_B, accumulated_C, accumulated_D)
accumulated_A_B_C_D
```


```{r}
# DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
# DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
# #plotting total species accumulation over time
# ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(No_Taxa), group = Analysis_Type, color = Analysis_Type)) +
#   geom_smooth( size=1.3, alpha=0.8, level = 0, method = "loess", fullrange=TRUE) +
#   scale_color_viridis(discrete = TRUE) +
#   scale_x_continuous(breaks = c(1920, 1940, 1960, 1980, 2000, 2020)) +
#    guides(colour = guide_legend(reverse=T)) +
#  theme_light() +
#   labs(title = "Scenario 2 Nat Rate", x = "Year", y = "Total Naturalized Species")
# ggsave(filename = "Scenario2_ rate_2025.png", device = "png", scale = 1, width =6, dpi = 600)
```

```{r}
DATA <- accumulated_A_B_C_D %>% mutate(Analysis_Type = fct_reorder(Analysis_Type, accumulated_species))
DATA <- subset(DATA, DATA$Analysis_Type != "Compiled date")
DATA <- subset(DATA, DATA$Analysis_Type != "Report date")

DATA$Scenario <- "Both lag types lengthen"
dp_fslagslengthen <- DATA


# Get more colors than needed so we can discard bad ones
all_colors <- viridis(4, option = "D")

n_colors <- length(unique(DATA$Analysis_Type))

# Filter out the very lightest color (often at the end)
# You can tweak this filter logic â€” here we drop colors with high brightness
drop_yellowish <- function(col_vec, n_keep) {
  rgb_vals <- col2rgb(col_vec)
  brightness <- apply(rgb_vals, 2, mean)  # crude brightness
  keep_indices <- order(brightness)[1:n_keep]
  col_vec[keep_indices]
}

# Keep just the best contrasting n colors
my_colors <- drop_yellowish(all_colors, n_colors)


#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=2, alpha=0.7) +
  scale_color_manual(values = rev(my_colors)) +
  scale_x_continuous(breaks = c(1900,1920, 1940, 1960, 1980, 2000, 2020)) +
 theme_light() +
  theme(legend.title=element_blank(), legend.position = "none", panel.border = element_blank()) +
  labs(title = "G:  Field Surveying & Data Processing \n Lags Lengthen Over Time", x = "Year", y = "Total Naturalized Species")
ggsave(filename = "Fig3_FSandDP_steadylengthen_2025.png", device = "png", scale = 1, width =4, dpi = 600)
```


### FINAL Figures


```{r}
DATA <- alllagsconstant

library(viridisLite)
library(forcats)
library(ggplot2)

## -- 1  Desired legend / plotting order -------------------------------------
my_order <- c("True naturalization date",
              "Estimated introduction date",
              "Detection date")


## Make sure the factor follows that order 
DATA$Scenario <- fct_relevel(DATA$Scenario, my_order)

## -- 2  Helper to drop the brightest colours-------
drop_yellowish <- function(col_vec, n_keep) {
  n_keep <- max(1, min(n_keep, length(col_vec)))
  rgb_vals   <- col2rgb(col_vec)
  brightness <- colMeans(rgb_vals)
  keep_idx   <- order(brightness)[seq_len(n_keep)]
  col_vec[keep_idx]
}

## -- 3  Build the palette ----------------------------------------------------
n_other   <- length(my_order) - 1                        # colours *besides* black
raw_cols  <- viridis(n_other + 1, option = "D")          # overâ€‘sample a bit
vir_cols  <- drop_yellowish(raw_cols, n_other)           # keep nicest n_other
named_cols <- c("True naturalization date" = "gray46",
                setNames(vir_cols, my_order[-1]))




#plotting total species accumulation over time
ggplot(DATA, aes(x=as.numeric(Year), y=as.numeric(accumulated_species), group = Analysis_Type, color = Analysis_Type)) +
  geom_line( size=1.5, alpha=0.75) +
  scale_color_manual(values = named_cols) +
  scale_x_continuous(breaks = c(1900, 1920, 1940, 1960, 1980, 2000, 2020)) +
  #guides(colour = guide_legend(reverse=T)) +
 theme_light() +
  theme(legend.title=element_blank(), legend.position="right", panel.border = element_blank()) +
  labs(title = "A:", x = "Year", y = "Total naturalized species")
ggsave(filename = "Fig4a_FINAL_Intro_v_Detect_2025.png", device = "png", scale = 1, width =7, dpi = 600)

#   The difference between using Detection date versus estimated \n introduction date in analyses (lag lengths constant over time) 
```


```{r}
truenaturalizationdate <- subset(alllagsconstant, alllagsconstant$Analysis_Type == "True naturalization date")
truenaturalizationdate$Scenario <- "True naturalization date"
truenaturalizationdate
```


```{r}
alllagsconstant <- subset(alllagsconstant, alllagsconstant$Analysis_Type == "Detection date")
dplagsshorten <- subset(dplagsshorten, dplagsshorten$Analysis_Type == "Detection date")
dplagslengthen <- subset(dplagslengthen, dplagslengthen$Analysis_Type == "Detection date")
fslagsshorten <- subset(fslagsshorten, fslagsshorten$Analysis_Type == "Detection date")
fslagslengthen <- subset(fslagslengthen, fslagslengthen$Analysis_Type == "Detection date")
dp_fslagsshorten <- subset(dp_fslagsshorten, dp_fslagsshorten$Analysis_Type == "Detection date")
dp_fslagslengthen <- subset(dp_fslagslengthen, dp_fslagslengthen$Analysis_Type == "Detection date")

DATA <- rbind(truenaturalizationdate, alllagsconstant, dplagsshorten, fslagsshorten, dp_fslagsshorten)


library(viridisLite)
library(forcats)
library(ggplot2)

## -- 1  Desired legend / plotting order -------------------------------------
my_order <- c("True naturalization date",
              "Both lag types shorten",
              "Field surveying lags shorten",
              "Data processing lags shorten",
              "Both lag types constant")

## Make sure the factor follows that order (optional but convenient)
DATA$Scenario <- fct_relevel(DATA$Scenario, my_order)

## -- 2  Helper to drop the brightest colours (unchanged from earlier) -------
drop_yellowish <- function(col_vec, n_keep) {
  n_keep <- max(1, min(n_keep, length(col_vec)))
  rgb_vals   <- col2rgb(col_vec)
  brightness <- colMeans(rgb_vals)
  keep_idx   <- order(brightness)[seq_len(n_keep)]
  col_vec[keep_idx]
}

## -- 3  Build the palette ----------------------------------------------------
n_other   <- length(my_order) - 1                        # colours *besides* black
raw_cols  <- viridis(n_other + 1, option = "D")          # overâ€‘sample a bit
vir_cols  <- drop_yellowish(raw_cols, n_other)           # keep nicest n_other
named_cols <- c("True naturalization date" = "gray46",
                setNames(vir_cols, my_order[-1]))

## -- 4  Plot -----------------------------------------------------------------
ggplot(DATA,
       aes(x = as.integer(Year), y = accumulated_species,
           colour = Scenario, group = Scenario)) +
  geom_line(size = 1.5, alpha = 0.75) +
  scale_colour_manual(breaks = my_order, values = named_cols) +
 scale_x_continuous(breaks = c(1900,1920, 1940, 1960, 1980, 2000, 2020)) +
 theme_light() +
  theme(legend.title=element_blank(), legend.position="right", panel.border = element_blank()) +
  labs(title = "", x = "Year", y = "Total naturalized species")
ggsave(filename = "Fig3_FINAL_Compare_Scenarios_2025.png", device = "png", scale = 1, width =7, dpi = 600)

```



